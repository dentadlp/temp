<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Advanced Server Installation &mdash; Netmaker 0.24.3 documentation</title>
      <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
      <link rel="stylesheet" href="_static/custom.css" type="text/css" />
      <link rel="stylesheet" href="_static/fonts.css" type="text/css" />
      <link rel="stylesheet" href="_static/netmaker-custom.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="./" id="documentation_options" src="_static/documentation_options.js"></script>
        <script src="_static/jquery.js"></script>
        <script src="_static/underscore.js"></script>
        <script src="_static/doctools.js"></script>
    <script src="_static/js/theme.js"></script>
    <link rel="author" title="About these documents" href="about.html" />
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Features" href="features.html" />
    <link rel="prev" title="Advanced Client Installation" href="advanced-client-install.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="index.html" class="icon icon-home">
            Netmaker
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="about.html">About</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="getting-started.html">Getting Started</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="install.html">Install</a></li>
<li class="toctree-l2"><a class="reference internal" href="manual-install.html">Manual Install</a></li>
<li class="toctree-l2"><a class="reference internal" href="netclient.html">Netclient</a></li>
<li class="toctree-l2"><a class="reference internal" href="advanced-client-install.html">Advanced Client Installation</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">Advanced Server Installation</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#system-compatibility">System Compatibility</a></li>
<li class="toctree-l3"><a class="reference internal" href="#server-configuration-reference">Server Configuration Reference</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#variable-description">Variable Description</a></li>
<li class="toctree-l4"><a class="reference internal" href="#compose-file-annotated">Compose File - Annotated</a></li>
<li class="toctree-l4"><a class="reference internal" href="#available-docker-compose-files">Available docker-compose files</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#emqx">EMQX</a></li>
<li class="toctree-l3"><a class="reference internal" href="#nginx-reverse-proxy-setup-with-https">Nginx Reverse Proxy Setup with https</a></li>
<li class="toctree-l3"><a class="reference internal" href="#nginx-proxy-manager-setup">Nginx Proxy Manager Setup</a></li>
<li class="toctree-l3"><a class="reference internal" href="#highly-available-installation-kubernetes">Highly Available Installation (Kubernetes)</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#requirements">Requirements</a></li>
<li class="toctree-l4"><a class="reference internal" href="#example-installations">Example Installations:</a></li>
<li class="toctree-l4"><a class="reference internal" href="#recommended-settings">Recommended Settings:</a></li>
<li class="toctree-l4"><a class="reference internal" href="#mq">MQ</a></li>
<li class="toctree-l4"><a class="reference internal" href="#ingress">Ingress</a></li>
<li class="toctree-l4"><a class="reference internal" href="#dns">DNS</a></li>
<li class="toctree-l4"><a class="reference internal" href="#values">Values</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#security-settings">Security Settings</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#for-caddy">For Caddy</a></li>
<li class="toctree-l4"><a class="reference internal" href="#for-traefik">For Traefik</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#setup-netmaker-on-ipv6-only-machine">Setup Netmaker on IPv6 only machine</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#about-the-install-script-nm-quick-sh">About the install script nm-quick.sh</a></li>
<li class="toctree-l4"><a class="reference internal" href="#add-aaaa-record-for-domain-name-resolution">Add AAAA record for domain name resolution</a></li>
<li class="toctree-l4"><a class="reference internal" href="#enable-ipv6-support-for-docker">Enable IPv6 support for Docker</a></li>
<li class="toctree-l4"><a class="reference internal" href="#enable-ipv6-support-for-netmaker">Enable IPv6 support for Netmaker</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="getting-started.html#setup">Setup</a></li>
<li class="toctree-l2"><a class="reference internal" href="getting-started.html#create-a-network">Create a Network</a></li>
<li class="toctree-l2"><a class="reference internal" href="getting-started.html#create-a-key">Create a Key</a></li>
<li class="toctree-l2"><a class="reference internal" href="getting-started.html#deploy-nodes">Deploy Nodes</a></li>
<li class="toctree-l2"><a class="reference internal" href="getting-started.html#manage-nodes-hosts">Manage Nodes/Hosts</a></li>
<li class="toctree-l2"><a class="reference internal" href="getting-started.html#uninstalling-the-netclient">Uninstalling the netclient</a></li>
<li class="toctree-l2"><a class="reference internal" href="getting-started.html#uninstalling-netmaker">Uninstalling Netmaker</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="features.html">Features</a></li>
<li class="toctree-l1"><a class="reference internal" href="pro/index.html">Netmaker Professional</a></li>
<li class="toctree-l1"><a class="reference internal" href="upgrades.html">Upgrades</a></li>
<li class="toctree-l1"><a class="reference internal" href="how-to-guides.html">How-to-Guides</a></li>
<li class="toctree-l1"><a class="reference internal" href="references.html">References</a></li>
<li class="toctree-l1"><a class="reference internal" href="license.html">License</a></li>
<li class="toctree-l1"><a class="reference internal" href="conduct.html">Code of Conduct</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">Netmaker</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="getting-started.html">Getting Started</a></li>
      <li class="breadcrumb-item active">Advanced Server Installation</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="advanced-server-installation">
<h1>Advanced Server Installation<a class="headerlink" href="#advanced-server-installation" title="Permalink to this headline"></a></h1>
<p>This section outlines installing the Netmaker server, including Netmaker, Netmaker UI, rqlite, and CoreDNS.</p>
<section id="system-compatibility">
<h2>System Compatibility<a class="headerlink" href="#system-compatibility" title="Permalink to this headline"></a></h2>
<p>Netmaker requires elevated privileges on the host machine to perform network operations. Netmaker must be able to modify interfaces and set firewall rules using iptables.</p>
<p>Typically, Netmaker is run inside of containers, using Docker or Kubernetes.</p>
<p>Netmaker can be run without containers, but this is not recommended. You must run the Netmaker binary, CoreDNS binary, database, and a web server directly on the host.</p>
<p>Each of these components has its own individual requirements and the management complexity increases exponentially by running outside of containers.</p>
<p>For first-time installs, we recommend the quick install guide. The following documents are meant for more advanced installation environments and are not recommended for most users. However, these documents can be helpful in customizing or troubleshooting your own installation.</p>
</section>
<section id="server-configuration-reference">
<span id="id1"></span><h2>Server Configuration Reference<a class="headerlink" href="#server-configuration-reference" title="Permalink to this headline"></a></h2>
<p>Netmaker sets its configuration in the following order of precedence:</p>
<ol class="arabic simple">
<li><p><strong>Environment Variables:</strong> Typically values set in the Docker Compose. This is the most common way of setting server values.</p></li>
<li><p><strong>Config File:</strong> Values set in the <code class="docutils literal notranslate"><span class="pre">config/environments/*.yaml</span></code> file.</p></li>
<li><p><strong>Defaults:</strong> Default values set on the server if no value is provided in configuration.</p></li>
</ol>
<p>In most situations, if you wish to modify a server setting, set it in the netmaker.env file, then run “docker kill netmaker” and “docker-compose up -d”.</p>
<section id="variable-description">
<h3>Variable Description<a class="headerlink" href="#variable-description" title="Permalink to this headline"></a></h3>
<dl>
<dt>NM_EMAIL</dt><dd><p><strong>Default</strong> “”</p>
<p><strong>Description</strong> Email used for SSL certificates</p>
</dd>
<dt>NM_DOMAIN</dt><dd><p><strong>Default:</strong> “”</p>
<p><strong>Description:</strong>  Public IP of machine</p>
</dd>
<dt>SERVER_HOST</dt><dd><p><strong>Default:</strong> (Server detects the public IP address of machine)</p>
<p><strong>Description:</strong> The public IP of the server where the machine is running.</p>
</dd>
<dt>MASTER_KEY</dt><dd><p><strong>Default:</strong> “secretkey”</p>
<p><strong>Description:</strong> The admin master key for accessing the API. Change this in any production installation.</p>
</dd>
<dt>MQ_USERNAME</dt><dd><p><strong>Default</strong> “”</p>
<p><strong>Description</strong> The username to set for MQ access</p>
</dd>
<dt>MQ_PASSWORD</dt><dd><p><strong>Default</strong> “”</p>
<p><strong>Description</strong> The password to set for MQ access</p>
</dd>
<dt>INSTALL_TYPE</dt><dd><p><strong>Default</strong> ce</p>
<p><strong>Description</strong> The installation type to run on the server. “ce” will run community edition. “pro” will run professional edition if you have an on-prem tenant.</p>
</dd>
</dl>
<p>LICENSE_KEY</p>
<blockquote>
<div><p><strong>Default</strong> “”</p>
<p><strong>Description</strong> The license key from your on-prem tenent needed to validate your professional installation.</p>
</div></blockquote>
<p>NETMAKER_TENANT_ID</p>
<blockquote>
<div><p><strong>Default</strong> “”</p>
<p><strong>Description</strong> The ID of your on-prem tenant used to validate your professional installation.</p>
</div></blockquote>
<p>SERVER_IMAGE_TAG</p>
<blockquote>
<div><p><strong>Default</strong></p>
<p><strong>Description</strong> The tag used for the server docker image. You can set it to “latest” to get the most up to date version. To stay on a certain version set the tag to the version you would like. ex: v0.24.2. if using a pro image, add “-ee” after the version. ex: v0.24.2-ee.</p>
</div></blockquote>
<p>UI_IMAGE_TAG</p>
<blockquote>
<div><p><strong>Default</strong> “”</p>
<p><strong>Description</strong> The tag used for the netmaker ui docker image. You can set it to “latest” to get the most up to date version. To stay on a certain version set the tag to the version you would like. ex: v0.24.2.</p>
</div></blockquote>
<p>METRICS_EXPORTER</p>
<blockquote>
<div><p><strong>Default</strong> off</p>
<p><strong>Description</strong> This is a pro feature that exports metrics to the netmaker server.</p>
</div></blockquote>
<p>PROMETHEUS</p>
<blockquote>
<div><p><strong>Default</strong> off</p>
<p><strong>Description</strong> This is a pro feature. Prometheus is an open-source systems monitoring and alerting toolkit originally built at SoundCloud. It is used in out metrics collection</p>
</div></blockquote>
<p>DNS_MODE</p>
<blockquote>
<div><p><strong>Default</strong> on</p>
<p><strong>Description</strong> Enables DNS Mode, meaning all nodes will set hosts file for private dns settings</p>
</div></blockquote>
<p>NETCLIENT_AUTO_UPDATE</p>
<blockquote>
<div><p><strong>Default</strong> enabled</p>
<p><strong>Description</strong> Enable/Disable auto update of netclient</p>
</div></blockquote>
<p>API_PORT</p>
<blockquote>
<div><p><strong>Default</strong> 8081</p>
<p><strong>Description</strong> The HTTP API port for Netmaker. Used for API calls / communication from front end. If changed, need to change port of BACKEND_URL for netmaker-ui.</p>
</div></blockquote>
<p>EXPORTER_API_PORT</p>
<blockquote>
<div><p><strong>Default</strong> 8085</p>
<p><strong>Description</strong> the API port to set for the metrics exporter.</p>
</div></blockquote>
<p>CORS_ALLOWED_ORIGIN</p>
<blockquote>
<div><p><strong>Default</strong> “*”</p>
<p><strong>Description</strong> The “allowed origin” for API requests. Change to restrict where API requests can come from with comma-separated URLs. ex:- <a class="reference external" href="https://dashboard.netmaker.domain1.com,https://dashboard.netmaker.domain2.com">https://dashboard.netmaker.domain1.com,https://dashboard.netmaker.domain2.com</a></p>
</div></blockquote>
<p>DISPLAY_KEYS</p>
<blockquote>
<div><p><strong>Default</strong> on</p>
<p><strong>Description</strong> Show keys permanently in UI (until deleted) as opposed to 1-time display.</p>
</div></blockquote>
<p>DATABASE</p>
<blockquote>
<div><p><strong>Default</strong> sqlite</p>
<p><strong>Description</strong> Database to use - sqlite, postgres, or rqlite</p>
</div></blockquote>
<p>SERVER_BROKER_ENDPOINT</p>
<blockquote>
<div><p><strong>Default</strong> ws://mq:1883</p>
<p><strong>Description</strong> The address of the mq server. If running from docker compose it will be “mq”. Otherwise, need to input address. If using “host networking”, it will find and detect the IP of the mq container. For EMQX websockets use <cite>SERVER_BROKER_ENDPOINT=ws://mq:8083/mqtt</cite></p>
</div></blockquote>
<p>VERBOSITY</p>
<blockquote>
<div><p><strong>Default</strong> 1</p>
<p><strong>Description</strong> Logging verbosity level - 1, 2, 3, or 4</p>
</div></blockquote>
<p>REST_BACKEND</p>
<blockquote>
<div><p><strong>Default</strong> on</p>
<p><strong>Description</strong> Enables the REST backend (API running on API_PORT at SERVER_HTTP_HOST).</p>
</div></blockquote>
<p>DISABLE_REMOTE_IP_CHECK</p>
<blockquote>
<div><p><strong>Default</strong> off</p>
<p><strong>Description</strong> If turned “on”, Server will not set Host based on remote IP check. This is already overridden if SERVER_HOST is set.</p>
</div></blockquote>
<p>TELEMETRY</p>
<blockquote>
<div><p><strong>Default</strong> on</p>
<p><strong>Description</strong> Whether or not to send telemetry data to help improve Netmaker. Switch to “off” to opt out of sending telemetry.</p>
</div></blockquote>
<p>ALLOWED_EMAIL_DOMAINS</p>
<blockquote>
<div><p><strong>Default</strong> “*”</p>
<p><strong>Description</strong> only mentioned domains will be allowded to signup using oauth, by default all domains are allowed</p>
</div></blockquote>
<p>AUTH_PROVIDER</p>
<blockquote>
<div><p><strong>Default</strong> “”</p>
<p><strong>Description</strong> You can use azure-ad, github, google, oidc</p>
</div></blockquote>
<p>CLIENT_ID</p>
<blockquote>
<div><p><strong>Default</strong> “”</p>
<p><strong>Description</strong> The client id of your oauth provider.</p>
</div></blockquote>
<p>CLIENT_SECRET</p>
<blockquote>
<div><p><strong>Default</strong> “”</p>
<p><strong>Description</strong> The client secret of your oauth provider.</p>
</div></blockquote>
<p>FRONTEND_URL</p>
<blockquote>
<div><p><strong>Default</strong> “”</p>
<p><strong>Description</strong> <a class="reference external" href="https://dashboard">https://dashboard</a>.&lt;netmaker base domain&gt;</p>
</div></blockquote>
<p>AZURE_TENANT</p>
<blockquote>
<div><p><strong>Default</strong> “”</p>
<p><strong>Description</strong> only for azure, you may optionally specify the tenant for the OAuth</p>
</div></blockquote>
<p>OIDC_ISSUER</p>
<blockquote>
<div><p><strong>Default</strong> “”</p>
<p><strong>Description</strong> <a class="reference external" href="https://oidc.yourprovider.com">https://oidc.yourprovider.com</a> - URL of oidc provider</p>
</div></blockquote>
<p>JWT_VALIDITY_DURATION</p>
<blockquote>
<div><p><strong>Default</strong> 43200</p>
<p><strong>Description</strong> Duration of JWT token validity in seconds</p>
</div></blockquote>
<p>RAC_AUTO_DISABLE</p>
<blockquote>
<div><p><strong>Default</strong> false</p>
<p><strong>Description</strong> Auto disable a user’s connected clients based on JWT token expiration</p>
</div></blockquote>
<p>CACHING_ENABLED</p>
<blockquote>
<div><p><strong>Default</strong> true</p>
<p><strong>Description</strong> if turned on data will be cached on to improve performance significantly (IMPORTANT: If HA set to <cite>false</cite> )</p>
</div></blockquote>
<p>ENDPOINT_DETECTION</p>
<blockquote>
<div><p><strong>Default</strong> true</p>
<p><strong>Description</strong> if turned on netclient checks if peers are reachable over private/LAN address, and choose that as peer endpoint</p>
</div></blockquote>
</section>
<section id="compose-file-annotated">
<h3>Compose File - Annotated<a class="headerlink" href="#compose-file-annotated" title="Permalink to this headline"></a></h3>
<p>All environment variables and options are enabled in this file. It is the equivalent to running the “full install” from the above section. However, all environment variables are included and are set to the default values provided by Netmaker (if the environment variable was left unset, it would not change the installation). Comments are added to each option to show how you might use it to modify your installation.</p>
<p>As of v0.18.0, netmaker now uses a stun server (Session Traversal Utilities for NAT). This provides a tool for communications protocols to detect and traverse NATs that are located in the path between two endpoints. By default, netmaker uses publicly available STUN servers.  You are free to set up your own stun severs and use those to augment/replace the public STUN servers. Update the STUN_LIST to list the STUN servers you wish to use. Two resources for installing your own STUN server are:</p>
<p><a class="reference external" href="https://ourcodeworld.com/articles/read/1175/how-to-create-and-configure-your-own-stun-turn-server-with-coturn-in-ubuntu-18-04">https://ourcodeworld.com/articles/read/1175/how-to-create-and-configure-your-own-stun-turn-server-with-coturn-in-ubuntu-18-04</a></p>
<p><a class="reference external" href="https://cloudkul.com/blog/how-to-install-turn-stun-server-on-aws-ubuntu-20-04/">https://cloudkul.com/blog/how-to-install-turn-stun-server-on-aws-ubuntu-20-04/</a></p>
<p>There are also some environment variables that have been changed, or removed. Your updated docker-compose and .env files should look like this.</p>
<div class="highlight-YAML notranslate"><div class="highlight"><pre><span></span><span class="nt">version</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;3.4&quot;</span><span class="w"></span>

<span class="nt">services</span><span class="p">:</span><span class="w"></span>

<span class="w">  </span><span class="nt">netmaker</span><span class="p">:</span><span class="w"></span>
<span class="w">    </span><span class="nt">container_name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">netmaker</span><span class="w"></span>
<span class="w">    </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">gravitl/netmaker:$SERVER_IMAGE_TAG</span><span class="w"></span>
<span class="w">    </span><span class="nt">env_file</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">./netmaker.env</span><span class="w"></span>
<span class="w">    </span><span class="nt">restart</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">always</span><span class="w"></span>
<span class="w">    </span><span class="nt">volumes</span><span class="p">:</span><span class="w"></span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">dnsconfig:/root/config/dnsconfig</span><span class="w"></span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">sqldata:/root/data</span><span class="w"></span>
<span class="w">    </span><span class="nt">environment</span><span class="p">:</span><span class="w"></span>
<span class="w">      </span><span class="c1"># config-dependant vars</span><span class="w"></span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">STUN_LIST=stun1.netmaker.io:3478,stun2.netmaker.io:3478,stun1.l.google.com:19302,stun2.l.google.com:19302</span><span class="w"></span>
<span class="w">      </span><span class="c1"># The domain/host IP indicating the mq broker address</span><span class="w"></span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">BROKER_ENDPOINT=wss://broker.${NM_DOMAIN}</span><span class="w"></span>
<span class="w">      </span><span class="c1"># The base domain of netmaker</span><span class="w"></span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">SERVER_NAME=${NM_DOMAIN}</span><span class="w"></span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">SERVER_API_CONN_STRING=api.${NM_DOMAIN}:443</span><span class="w"></span>
<span class="w">      </span><span class="c1"># Address of the CoreDNS server. Defaults to SERVER_HOST</span><span class="w"></span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">COREDNS_ADDR=${SERVER_HOST}</span><span class="w"></span>
<span class="w">      </span><span class="c1"># Overrides SERVER_HOST if set. Useful for making HTTP available via different interfaces/networks.</span><span class="w"></span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">SERVER_HTTP_HOST=api.${NM_DOMAIN}</span><span class="w"></span>

<span class="w">  </span><span class="nt">netmaker-ui</span><span class="p">:</span><span class="w"></span>
<span class="w">    </span><span class="nt">container_name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">netmaker-ui</span><span class="w"></span>
<span class="w">    </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">gravitl/netmaker-ui:$UI_IMAGE_TAG</span><span class="w"></span>
<span class="w">    </span><span class="nt">env_file</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">./netmaker.env</span><span class="w"></span>
<span class="w">    </span><span class="nt">environment</span><span class="p">:</span><span class="w"></span>
<span class="w">      </span><span class="c1"># config-dependant vars</span><span class="w"></span>
<span class="w">      </span><span class="c1"># URL where UI will send API requests. Change based on SERVER_HOST, SERVER_HTTP_HOST, and API_PORT</span><span class="w"></span>
<span class="w">      </span><span class="nt">BACKEND_URL</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;https://api.${NM_DOMAIN}&quot;</span><span class="w"></span>
<span class="w">    </span><span class="nt">depends_on</span><span class="p">:</span><span class="w"></span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">netmaker</span><span class="w"></span>
<span class="w">    </span><span class="nt">links</span><span class="p">:</span><span class="w"></span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">&quot;netmaker:api&quot;</span><span class="w"></span>
<span class="w">    </span><span class="nt">restart</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">always</span><span class="w"></span>

<span class="w">  </span><span class="nt">caddy</span><span class="p">:</span><span class="w"></span>
<span class="w">    </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">caddy:2.6.2</span><span class="w"></span>
<span class="w">    </span><span class="nt">container_name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">caddy</span><span class="w"></span>
<span class="w">    </span><span class="nt">env_file</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">./netmaker.env</span><span class="w"></span>
<span class="w">    </span><span class="nt">restart</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">unless-stopped</span><span class="w"></span>
<span class="w">    </span><span class="nt">extra_hosts</span><span class="p">:</span><span class="w"></span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">&quot;host.docker.internal:host-gateway&quot;</span><span class="w"></span>
<span class="w">    </span><span class="nt">volumes</span><span class="p">:</span><span class="w"></span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">./Caddyfile:/etc/caddy/Caddyfile</span><span class="w"></span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">./certs:/root/certs</span><span class="w"></span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">caddy_data:/data</span><span class="w"></span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">caddy_conf:/config</span><span class="w"></span>
<span class="w">    </span><span class="nt">ports</span><span class="p">:</span><span class="w"></span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">&quot;80:80&quot;</span><span class="w"></span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">&quot;443:443&quot;</span><span class="w"></span>

<span class="w">  </span><span class="nt">coredns</span><span class="p">:</span><span class="w"></span>
<span class="w">    </span><span class="nt">container_name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">coredns</span><span class="w"></span>
<span class="w">    </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">coredns/coredns</span><span class="w"></span>
<span class="w">    </span><span class="nt">command</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">-conf /root/dnsconfig/Corefile</span><span class="w"></span>
<span class="w">    </span><span class="nt">env_file</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">./netmaker.env</span><span class="w"></span>
<span class="w">    </span><span class="nt">depends_on</span><span class="p">:</span><span class="w"></span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">netmaker</span><span class="w"></span>
<span class="w">    </span><span class="nt">restart</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">always</span><span class="w"></span>
<span class="w">    </span><span class="nt">volumes</span><span class="p">:</span><span class="w"></span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">dnsconfig:/root/dnsconfig</span><span class="w"></span>
<span class="w">  </span><span class="nt">mq</span><span class="p">:</span><span class="w"></span>
<span class="w">    </span><span class="nt">container_name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">mq</span><span class="w"></span>
<span class="w">    </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">eclipse-mosquitto:2.0.15-openssl</span><span class="w"></span>
<span class="w">    </span><span class="nt">env_file</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">./netmaker.env</span><span class="w"></span>
<span class="w">    </span><span class="nt">depends_on</span><span class="p">:</span><span class="w"></span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">netmaker</span><span class="w"></span>
<span class="w">    </span><span class="nt">restart</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">unless-stopped</span><span class="w"></span>
<span class="w">    </span><span class="nt">command</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="w"> </span><span class="s">&quot;/mosquitto/config/wait.sh&quot;</span><span class="w"> </span><span class="p p-Indicator">]</span><span class="w"></span>
<span class="w">    </span><span class="nt">volumes</span><span class="p">:</span><span class="w"></span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">./mosquitto.conf:/mosquitto/config/mosquitto.conf</span><span class="w"></span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">./wait.sh:/mosquitto/config/wait.sh</span><span class="w"></span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">mosquitto_logs:/mosquitto/log</span><span class="w"></span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">mosquitto_data:/mosquitto/data</span><span class="w"></span>

<span class="nt">volumes</span><span class="p">:</span><span class="w"></span>
<span class="w">  </span><span class="nt">caddy_data</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">{</span><span class="w"> </span><span class="p p-Indicator">}</span><span class="w"> </span><span class="c1"># runtime data for caddy</span><span class="w"></span>
<span class="w">  </span><span class="nt">caddy_conf</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">{</span><span class="w"> </span><span class="p p-Indicator">}</span><span class="w"> </span><span class="c1"># configuration file for Caddy</span><span class="w"></span>
<span class="w">  </span><span class="nt">sqldata</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">{</span><span class="w"> </span><span class="p p-Indicator">}</span><span class="w"></span>
<span class="w">  </span><span class="nt">dnsconfig</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">{</span><span class="w"> </span><span class="p p-Indicator">}</span><span class="w"> </span><span class="c1"># storage for coredns</span><span class="w"></span>
<span class="w">  </span><span class="nt">mosquitto_logs</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">{</span><span class="w"> </span><span class="p p-Indicator">}</span><span class="w"> </span><span class="c1"># storage for mqtt logs</span><span class="w"></span>
<span class="w">  </span><span class="nt">mosquitto_data</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">{</span><span class="w"> </span><span class="p p-Indicator">}</span><span class="w"> </span><span class="c1"># storage for mqtt data</span><span class="w"></span>
</pre></div>
</div>
<div class="highlight-YAML notranslate"><div class="highlight"><pre><span></span><span class="c1"># Email used for SSL certificates</span><span class="w"></span>
<span class="l l-Scalar l-Scalar-Plain">NM_EMAIL=</span><span class="w"></span>
<span class="l l-Scalar l-Scalar-Plain"># The base domain of netmaker</span><span class="w"></span>
<span class="l l-Scalar l-Scalar-Plain">NM_DOMAIN=</span><span class="w"></span>
<span class="l l-Scalar l-Scalar-Plain"># Public IP of machine</span><span class="w"></span>
<span class="l l-Scalar l-Scalar-Plain">SERVER_HOST=</span><span class="w"></span>
<span class="l l-Scalar l-Scalar-Plain"># The admin master key for accessing the API. Change this in any production installation.</span><span class="w"></span>
<span class="l l-Scalar l-Scalar-Plain">MASTER_KEY=</span><span class="w"></span>
<span class="l l-Scalar l-Scalar-Plain"># The username to set for MQ access</span><span class="w"></span>
<span class="l l-Scalar l-Scalar-Plain">MQ_USERNAME=</span><span class="w"></span>
<span class="l l-Scalar l-Scalar-Plain"># The password to set for MQ access</span><span class="w"></span>
<span class="l l-Scalar l-Scalar-Plain">MQ_PASSWORD=</span><span class="w"></span>
<span class="l l-Scalar l-Scalar-Plain">INSTALL_TYPE=</span><span class="w"></span>
<span class="l l-Scalar l-Scalar-Plain">NETMAKER_TENANT_ID=</span><span class="w"></span>
<span class="l l-Scalar l-Scalar-Plain">LICENSE_KEY=</span><span class="w"></span>
<span class="l l-Scalar l-Scalar-Plain">SERVER_IMAGE_TAG=</span><span class="w"></span>
<span class="l l-Scalar l-Scalar-Plain">UI_IMAGE_TAG=</span><span class="w"></span>
<span class="l l-Scalar l-Scalar-Plain">NETCLIENT_ENDPOINT_DETECTION=&quot;disabled&quot;</span><span class="w"></span>
<span class="l l-Scalar l-Scalar-Plain"># used for HA - identifies this server vs other servers</span><span class="w"></span>
<span class="l l-Scalar l-Scalar-Plain">NODE_ID=&quot;netmaker-server-1&quot;</span><span class="w"></span>
<span class="l l-Scalar l-Scalar-Plain">METRICS_EXPORTER=&quot;off&quot;</span><span class="w"></span>
<span class="l l-Scalar l-Scalar-Plain">PROMETHEUS=&quot;off&quot;</span><span class="w"></span>
<span class="l l-Scalar l-Scalar-Plain"># Enables DNS Mode, meaning all nodes will set hosts file for private dns settings</span><span class="w"></span>
<span class="l l-Scalar l-Scalar-Plain">DNS_MODE=&quot;on&quot;</span><span class="w"></span>
<span class="l l-Scalar l-Scalar-Plain"># Enable auto update of netclient ? ENUM:- enabled,disabled | default=enabled</span><span class="w"></span>
<span class="l l-Scalar l-Scalar-Plain">NETCLIENT_AUTO_UPDATE=&quot;enabled&quot;</span><span class="w"></span>
<span class="l l-Scalar l-Scalar-Plain"># The HTTP API port for Netmaker. Used for API calls / communication from front end.</span><span class="w"></span>
<span class="l l-Scalar l-Scalar-Plain"># If changed, need to change port of BACKEND_URL for netmaker-ui.</span><span class="w"></span>
<span class="l l-Scalar l-Scalar-Plain">API_PORT=&quot;8081&quot;</span><span class="w"></span>
<span class="l l-Scalar l-Scalar-Plain">EXPORTER_API_PORT=&quot;8085&quot;</span><span class="w"></span>
<span class="l l-Scalar l-Scalar-Plain"># The &quot;allowed origin&quot; for API requests. Change to restrict where API requests can come from with comma-separated</span><span class="w"></span>
<span class="l l-Scalar l-Scalar-Plain"># URLs. ex:- https://dashboard.netmaker.domain1.com,https://dashboard.netmaker.domain2.com</span><span class="w"></span>
<span class="l l-Scalar l-Scalar-Plain">CORS_ALLOWED_ORIGIN=&quot;*&quot;</span><span class="w"></span>
<span class="l l-Scalar l-Scalar-Plain"># Show keys permanently in UI (until deleted) as opposed to 1-time display.</span><span class="w"></span>
<span class="l l-Scalar l-Scalar-Plain">DISPLAY_KEYS=&quot;on&quot;</span><span class="w"></span>
<span class="l l-Scalar l-Scalar-Plain"># Database to use - sqlite, postgres, or rqlite</span><span class="w"></span>
<span class="l l-Scalar l-Scalar-Plain">DATABASE=&quot;sqlite&quot;</span><span class="w"></span>
<span class="l l-Scalar l-Scalar-Plain"># The address of the mq server. If running from docker compose it will be &quot;mq&quot;. Otherwise, need to input address.</span><span class="w"></span>
<span class="l l-Scalar l-Scalar-Plain"># If using &quot;host networking&quot;, it will find and detect the IP of the mq container.</span><span class="w"></span>
<span class="l l-Scalar l-Scalar-Plain">SERVER_BROKER_ENDPOINT=&quot;ws://mq:1883&quot;</span><span class="w"> </span><span class="c1"># For EMQX websockets use `SERVER_BROKER_ENDPOINT=ws://mq:8083/mqtt`</span><span class="w"></span>
<span class="c1"># The reachable port of STUN on the server</span><span class="w"></span>
<span class="l l-Scalar l-Scalar-Plain">STUN_PORT=&quot;3478&quot;</span><span class="w"></span>
<span class="l l-Scalar l-Scalar-Plain"># Logging verbosity level - 1, 2, or 3</span><span class="w"></span>
<span class="l l-Scalar l-Scalar-Plain">VERBOSITY=&quot;1&quot;</span><span class="w"></span>
<span class="l l-Scalar l-Scalar-Plain">DEBUG_MODE=&quot;off&quot;</span><span class="w"></span>
<span class="l l-Scalar l-Scalar-Plain"># Enables the REST backend (API running on API_PORT at SERVER_HTTP_HOST).</span><span class="w"></span>
<span class="l l-Scalar l-Scalar-Plain"># Change to &quot;off&quot; to turn off.</span><span class="w"></span>
<span class="l l-Scalar l-Scalar-Plain">REST_BACKEND=&quot;on&quot;</span><span class="w"></span>
<span class="l l-Scalar l-Scalar-Plain"># If turned &quot;on&quot;, Server will not set Host based on remote IP check.</span><span class="w"></span>
<span class="l l-Scalar l-Scalar-Plain"># This is already overridden if SERVER_HOST is set. Turned &quot;off&quot; by default.</span><span class="w"></span>
<span class="l l-Scalar l-Scalar-Plain">DISABLE_REMOTE_IP_CHECK=&quot;off&quot;</span><span class="w"></span>
<span class="l l-Scalar l-Scalar-Plain"># Whether or not to send telemetry data to help improve Netmaker. Switch to &quot;off&quot; to opt out of sending telemetry.</span><span class="w"></span>
<span class="l l-Scalar l-Scalar-Plain">TELEMETRY=&quot;on&quot;</span><span class="w"></span>
<span class="l l-Scalar l-Scalar-Plain">###</span><span class="w"></span>
<span class="l l-Scalar l-Scalar-Plain">#</span><span class="w"></span>
<span class="l l-Scalar l-Scalar-Plain"># OAuth section</span><span class="w"></span>
<span class="l l-Scalar l-Scalar-Plain">#</span><span class="w"></span>
<span class="l l-Scalar l-Scalar-Plain">###</span><span class="w"></span>
<span class="l l-Scalar l-Scalar-Plain"># &quot;&lt;azure-ad|github|google|oidc&gt;&quot;</span><span class="w"></span>
<span class="l l-Scalar l-Scalar-Plain">AUTH_PROVIDER=</span><span class="w"></span>
<span class="l l-Scalar l-Scalar-Plain"># &quot;&lt;client id of your oauth provider&gt;&quot;</span><span class="w"></span>
<span class="l l-Scalar l-Scalar-Plain">CLIENT_ID=</span><span class="w"></span>
<span class="l l-Scalar l-Scalar-Plain"># &quot;&lt;client secret of your oauth provider&gt;&quot;</span><span class="w"></span>
<span class="l l-Scalar l-Scalar-Plain">CLIENT_SECRET=</span><span class="w"></span>
<span class="l l-Scalar l-Scalar-Plain"># &quot;https://dashboard.&lt;netmaker base domain&gt;&quot;</span><span class="w"></span>
<span class="l l-Scalar l-Scalar-Plain">FRONTEND_URL=</span><span class="w"></span>
<span class="l l-Scalar l-Scalar-Plain"># &quot;&lt;only for azure, you may optionally specify the tenant for the OAuth&gt;&quot;</span><span class="w"></span>
<span class="l l-Scalar l-Scalar-Plain">AZURE_TENANT=</span><span class="w"></span>
<span class="l l-Scalar l-Scalar-Plain"># https://oidc.yourprovider.com - URL of oidc provider</span><span class="w"></span>
<span class="l l-Scalar l-Scalar-Plain">OIDC_ISSUER=</span><span class="w"></span>
</pre></div>
</div>
<p>Your Caddyfile should look like this.</p>
<div class="highlight-cfg notranslate"><div class="highlight"><pre><span></span><span class="na">{</span><span class="w"></span>

<span class="w">    </span><span class="na">email YOUR_EMAIL</span><span class="w"></span>
<span class="na">}</span><span class="w"></span>

<span class="c1"># Dashboard</span><span class="w"></span>
<span class="na">https://dashboard.NETMAKER_BASE_DOMAIN {</span><span class="w"></span>
<span class="w">    </span><span class="c1"># Apply basic security headers</span><span class="w"></span>
<span class="w">    </span><span class="na">header {</span><span class="w"></span>
<span class="w">            </span><span class="c1"># Enable cross origin access to *.NETMAKER_BASE_DOMAIN</span><span class="w"></span>
<span class="w">            </span><span class="na">Access-Control-Allow-Origin *.NETMAKER_BASE_DOMAIN</span><span class="w"></span>
<span class="w">            </span><span class="c1"># Enable HTTP Strict Transport Security (HSTS)</span><span class="w"></span>
<span class="w">            </span><span class="na">Strict-Transport-Security &quot;max-age</span><span class="o">=</span><span class="s">31536000;&quot;</span><span class="w"></span>
<span class="w">            </span><span class="c1"># Enable cross-site filter (XSS) and tell browser to block detected attacks</span><span class="w"></span>
<span class="w">            </span><span class="na">X-XSS-Protection &quot;1; mode</span><span class="o">=</span><span class="s">block&quot;</span><span class="w"></span>
<span class="w">            </span><span class="c1"># Disallow the site to be rendered within a frame on a foreign domain (clickjacking protection)</span><span class="w"></span>
<span class="w">            </span><span class="na">X-Frame-Options &quot;SAMEORIGIN&quot;</span><span class="w"></span>
<span class="w">            </span><span class="c1"># Prevent search engines from indexing</span><span class="w"></span>
<span class="w">            </span><span class="na">X-Robots-Tag &quot;none&quot;</span><span class="w"></span>
<span class="w">            </span><span class="c1"># Remove the server name</span><span class="w"></span>
<span class="w">            </span><span class="na">-Server</span><span class="w"></span>
<span class="w">    </span><span class="na">}</span><span class="w"></span>

<span class="w">    </span><span class="na">reverse_proxy http://netmaker-ui</span><span class="w"></span>
<span class="na">}</span><span class="w"></span>

<span class="c1"># API</span><span class="w"></span>
<span class="na">https://api.NETMAKER_BASE_DOMAIN {</span><span class="w"></span>
<span class="w">        </span><span class="na">reverse_proxy http://netmaker:8081</span><span class="w"></span>
<span class="na">}</span><span class="w"></span>

<span class="c1"># MQ</span><span class="w"></span>
<span class="na">wss://broker.NETMAKER_BASE_DOMAIN {</span><span class="w"></span>
<span class="w">        </span><span class="na">reverse_proxy ws://mq:8883</span><span class="w"></span>
<span class="na">}</span><span class="w"></span>
</pre></div>
</div>
</section>
<section id="available-docker-compose-files">
<h3>Available docker-compose files<a class="headerlink" href="#available-docker-compose-files" title="Permalink to this headline"></a></h3>
<p>The default options for docker-compose can be found here: <a class="reference external" href="https://github.com/gravitl/netmaker/tree/master/compose">https://github.com/gravitl/netmaker/tree/master/compose</a></p>
<p>The following is a brief description of each:</p>
<ul class="simple">
<li><p><a class="reference external" href="https://github.com/gravitl/netmaker/blob/master/compose/docker-compose.yml">docker-compose.yml</a> -= This maintains the most recommended setup at the moment, using the caddy proxy.</p></li>
<li><p><a class="reference external" href="https://github.com/gravitl/netmaker/blob/master/compose/docker-compose.pro.yml">docker-compose.pro.yml</a> -= This is the compose file needed for Netmaker Professional. You will need a licence and tenant id from <a class="reference external" href="https://account.netmaker.io/">Netmaker’s licence dashboard</a> .</p></li>
</ul>
</section>
</section>
<section id="emqx">
<span id="id2"></span><h2>EMQX<a class="headerlink" href="#emqx" title="Permalink to this headline"></a></h2>
<p>Netmaker offers an EMQX option as a broker for your server. The main configuration changes between mosquitto and EMQX is going to take place in the docker-compose.yml, netmaker.env and the Caddyfile.</p>
<p>You can find the EMQX docker-compose file <a class="reference external" href="https://github.com/gravitl/netmaker/blob/master/compose/docker-compose-emqx.yml">in the netmaker repo</a>.</p>
<p>You should not need to make any changes to the docker-compose-emqx.yml file. Just download this file using the command provided below on the same directory as netmaker.env file. It will grab information from the netmaker.env file.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">wget</span> <span class="n">https</span><span class="p">:</span><span class="o">//</span><span class="n">raw</span><span class="o">.</span><span class="n">githubusercontent</span><span class="o">.</span><span class="n">com</span><span class="o">/</span><span class="n">gravitl</span><span class="o">/</span><span class="n">netmaker</span><span class="o">/</span><span class="n">master</span><span class="o">/</span><span class="n">compose</span><span class="o">/</span><span class="n">docker</span><span class="o">-</span><span class="n">compose</span><span class="o">-</span><span class="n">emqx</span><span class="o">.</span><span class="n">yml</span>
</pre></div>
</div>
<p>In your Caddyfile, the only change you need to make is in the mq block.</p>
<div class="highlight-cfg notranslate"><div class="highlight"><pre><span></span><span class="c1"># MQ</span><span class="w"></span>
<span class="na">wss://broker.{$NM_DOMAIN} {</span><span class="w"></span>
<span class="w">    </span><span class="na">reverse_proxy ws://mq:8083</span><span class="w"></span>
<span class="na">}</span><span class="w"></span>
</pre></div>
</div>
<p>basically just replace the port number on line <code class="docutils literal notranslate"><span class="pre">reverse_proxy</span> <span class="pre">ws://mq:8883</span></code> with <code class="docutils literal notranslate"><span class="pre">8083</span></code> emqx websocket port number.</p>
<p>In your netmaker.env file, just replace the line <code class="docutils literal notranslate"><span class="pre">SERVER_BROKER_ENDPOINT=&quot;ws://mq:1883&quot;</span></code> with <code class="docutils literal notranslate"><span class="pre">SERVER_BROKER_ENDPOINT=ws://mq:8083/mqtt</span></code>. Basically just change the port to 8083 and add /mqtt after that.</p>
<p>In your docker-compose.yml file, add <code class="docutils literal notranslate"><span class="pre">/mqtt</span></code> at the end of this line <code class="docutils literal notranslate"><span class="pre">BROKER_ENDPOINT=wss://broker.${NM_DOMAIN}</span></code> which results in <code class="docutils literal notranslate"><span class="pre">BROKER_ENDPOINT=wss://broker.${NM_DOMAIN}/mqtt</span></code>.</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">BROKER_ENDPOINT=wss://broker.${NM_DOMAIN}/mqtt</span><span class="w"></span>
<span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">BROKER_TYPE=emqx</span><span class="w"></span>
<span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">EMQX_REST_ENDPOINT=http://mq:18083</span><span class="w"></span>
</pre></div>
</div>
<p>Then two new lines <code class="docutils literal notranslate"><span class="pre">-</span> <span class="pre">BROKER_TYPE=emqx</span></code> and <code class="docutils literal notranslate"><span class="pre">-</span> <span class="pre">EMQX_REST_ENDPOINT=http://mq:18083</span></code> needs to be added after the line <code class="docutils literal notranslate"><span class="pre">-</span> <span class="pre">BROKER_ENDPOINT=wss://broker.${NM_DOMAIN}/mqtt</span></code> as shown above.</p>
<p>If you are using a professional server, you will need to make changes to your netmaker-exporter section in your docker-compose.override.yml file.</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">netmaker-exporter</span><span class="p">:</span><span class="w"></span>
<span class="w">    </span><span class="nt">container_name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">netmaker-exporter</span><span class="w"></span>
<span class="w">    </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">gravitl/netmaker-exporter:latest</span><span class="w"></span>
<span class="w">    </span><span class="nt">restart</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">always</span><span class="w"></span>
<span class="w">    </span><span class="nt">depends_on</span><span class="p">:</span><span class="w"></span>
<span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">netmaker</span><span class="w"></span>
<span class="w">    </span><span class="nt">environment</span><span class="p">:</span><span class="w"></span>
<span class="w">        </span><span class="nt">SERVER_BROKER_ENDPOINT</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;ws://mq:8083/mqtt&quot;</span><span class="w"></span>
<span class="w">        </span><span class="nt">BROKER_ENDPOINT</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;wss://broker.nm.${NM_DOMAIN}/mqtt&quot;</span><span class="w"></span>
<span class="w">        </span><span class="nt">PROMETHEUS_HOST</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;https://prometheus.${NM_DOMAIN}&quot;</span><span class="w"></span>
</pre></div>
</div>
<p>At this point you should be able to <code class="docutils literal notranslate"><span class="pre">docker-compose</span> <span class="pre">down</span> <span class="pre">&amp;&amp;</span> <span class="pre">docker-compose</span> <span class="pre">up</span> <span class="pre">-d</span> <span class="pre">&amp;&amp;</span> <span class="pre">docker-compose</span> <span class="pre">-f</span> <span class="pre">docker-compose-emqx.yml</span> <span class="pre">up</span> <span class="pre">-d</span></code>. Your <code class="docutils literal notranslate"><span class="pre">docker</span> <span class="pre">logs</span> <span class="pre">mq</span></code> should look something like this.</p>
<div class="highlight-cfg notranslate"><div class="highlight"><pre><span></span><span class="na">Listener ssl:default on 0.0.0.0:8883 started.</span><span class="w"></span>
<span class="na">Listener tcp:default on 0.0.0.0:1883 started.</span><span class="w"></span>
<span class="na">Listener ws:default on 0.0.0.0:8083 started.</span><span class="w"></span>
<span class="na">Listener wss:default on 0.0.0.0:8084 started.</span><span class="w"></span>
<span class="na">Listener http:dashboard on :18083 started.</span><span class="w"></span>
<span class="na">EMQX 5.0.9 is running now!</span><span class="w"></span>
</pre></div>
</div>
<p>Your server is now running on an EMQX broker. you can view your EMQX dashboard with <code class="docutils literal notranslate"><span class="pre">http://&lt;serverip&gt;:18083/</span></code>. The signin credentials are the EMQX_DASHBOARD__DEFAULT_USERNAME and EMQX_DASHBOARD__DEFAULT_PASSWORD located in your netmaker.env file. This dashboard will give you all the information about your mq activity going on in your netmaker server.</p>
</section>
<section id="nginx-reverse-proxy-setup-with-https">
<h2>Nginx Reverse Proxy Setup with https<a class="headerlink" href="#nginx-reverse-proxy-setup-with-https" title="Permalink to this headline"></a></h2>
<p>The <a class="reference external" href="https://github.com/linuxserver/docker-swag">Swag Proxy</a> makes it easy to generate a valid SSL certificate for the config below. Here is the <a class="reference external" href="https://docs.linuxserver.io/general/swag">documentation</a> for the installation.</p>
<p>The following file configures Netmaker as a subdomain. This config is an adaption from the swag proxy project.</p>
<p>./netmaker.subdomain.conf:</p>
<div class="highlight-nginx notranslate"><div class="highlight"><pre><span></span><span class="k">server</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="c1"># Redirect HTTP to HTTPS.</span>
<span class="w">    </span><span class="kn">listen</span><span class="w"> </span><span class="mi">80</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="kn">server_name</span><span class="w"> </span><span class="s">*.netmaker.example.org</span><span class="p">;</span><span class="w"> </span><span class="c1"># Please change to your domain</span>
<span class="w">    </span><span class="kn">return</span><span class="w"> </span><span class="mi">301</span><span class="w"> </span><span class="s">https://</span><span class="nv">$host$request_uri</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="k">server</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kn">listen</span><span class="w"> </span><span class="mi">443</span><span class="w"> </span><span class="s">ssl</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="kn">listen</span><span class="w"> </span><span class="s">[::]:443</span><span class="w"> </span><span class="s">ssl</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="kn">server_name</span><span class="w"> </span><span class="s">dashboard.netmaker.example.org</span><span class="p">;</span><span class="w"> </span><span class="c1"># Please change to your domain</span>
<span class="w">    </span><span class="kn">include</span><span class="w"> </span><span class="s">/config/nginx/ssl.conf</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="kn">location</span><span class="w"> </span><span class="s">/</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="kn">proxy_pass</span><span class="w"> </span><span class="s">http://&lt;NETMAKER_IP&gt;:8082</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="k">server</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kn">listen</span><span class="w"> </span><span class="mi">443</span><span class="w"> </span><span class="s">ssl</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="kn">listen</span><span class="w"> </span><span class="s">[::]:443</span><span class="w"> </span><span class="s">ssl</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="kn">server_name</span><span class="w"> </span><span class="s">api.netmaker.example.org</span><span class="p">;</span><span class="w"> </span><span class="c1"># Please change to your domain</span>
<span class="w">    </span><span class="kn">include</span><span class="w"> </span><span class="s">/config/nginx/ssl.conf</span><span class="p">;</span><span class="w"></span>

<span class="w">    </span><span class="kn">location</span><span class="w"> </span><span class="s">/</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="kn">proxy_pass</span><span class="w"> </span><span class="s">http://&lt;NETMAKER_IP&gt;:8081</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="kn">proxy_set_header</span><span class="w">            </span><span class="s">Host</span><span class="w"> </span><span class="s">api.netmaker.example.org</span><span class="p">;</span><span class="w"> </span><span class="c1"># Please change to your domain</span>
<span class="w">        </span><span class="kn">proxy_pass_request_headers</span><span class="w">  </span><span class="no">on</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
</pre></div>
</div>
</section>
<section id="nginx-proxy-manager-setup">
<h2>Nginx Proxy Manager Setup<a class="headerlink" href="#nginx-proxy-manager-setup" title="Permalink to this headline"></a></h2>
<p>To use Netmaker with Nginx Proxy Manager, three proxy hosts should be added, one for each subdomain used by netmaker. Each subdomain should have SSL enable and be configured as follows:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">api</span><span class="o">.</span><span class="n">netmaker</span><span class="o">.</span><span class="n">example</span><span class="o">.</span><span class="n">com</span><span class="p">:</span>
<span class="n">Forward</span> <span class="n">Hostname</span><span class="o">/</span><span class="n">IP</span><span class="p">:</span> <span class="n">netmaker</span>
<span class="n">Forward</span> <span class="n">Port</span><span class="p">:</span> <span class="mi">8081</span>
<span class="n">dashboard</span><span class="o">.</span><span class="n">netmaker</span><span class="o">.</span><span class="n">example</span><span class="o">.</span><span class="n">com</span><span class="p">:</span>
<span class="n">Forward</span> <span class="n">Hostname</span><span class="o">/</span><span class="n">IP</span><span class="p">:</span> <span class="n">netmaker</span><span class="o">-</span><span class="n">ui</span>
<span class="n">Forward</span> <span class="n">Port</span><span class="p">:</span> <span class="mi">80</span>
<span class="n">grpc</span><span class="o">.</span><span class="n">netmaker</span><span class="o">.</span><span class="n">example</span><span class="o">.</span><span class="n">com</span><span class="p">:</span>
<span class="n">Forward</span> <span class="n">Hostname</span><span class="o">/</span><span class="n">IP</span><span class="p">:</span> <span class="n">netmaker</span>
<span class="n">Forward</span> <span class="n">Port</span><span class="p">:</span> <span class="mi">50051</span>
<span class="n">Custom</span> <span class="n">Locations</span><span class="p">:</span>
<span class="n">Add</span> <span class="n">location</span> <span class="o">/</span>
<span class="n">Forward</span> <span class="n">Hostname</span><span class="o">/</span><span class="n">IP</span><span class="p">:</span> <span class="n">netmaker</span>
<span class="n">Forward</span> <span class="n">Port</span><span class="p">:</span> <span class="mi">50051</span>
<span class="n">Custom</span> <span class="n">config</span> <span class="p">(</span><span class="n">gear</span> <span class="n">button</span><span class="p">):</span> <span class="n">grpc_pass</span> <span class="n">netmaker</span><span class="p">:</span><span class="mi">50051</span><span class="p">;</span>
</pre></div>
</div>
<p>The following is a cleaned up config generated by Nginx Proxy Manager to show how nginx can be configured to support Netmaker. This does not include the neccessary SSL configuration.</p>
<div class="highlight-nginx notranslate"><div class="highlight"><pre><span></span><span class="c1"># ------------------------------------------------------------</span>
<span class="c1"># dashboard.netmaker.example.com</span>
<span class="c1"># ------------------------------------------------------------</span>
<span class="k">server</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="kn">set</span><span class="w"> </span><span class="nv">$forward_scheme</span><span class="w"> </span><span class="s">http</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="kn">set</span><span class="w"> </span><span class="nv">$server</span><span class="w">         </span><span class="s">&quot;netmaker-ui&quot;</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="kn">set</span><span class="w"> </span><span class="nv">$port</span><span class="w">           </span><span class="mi">80</span><span class="p">;</span><span class="w"></span>
<span class="kn">listen</span><span class="w"> </span><span class="mi">80</span><span class="p">;</span><span class="w"></span>
<span class="kn">listen</span><span class="w"> </span><span class="s">[::]:80</span><span class="p">;</span><span class="w"></span>
<span class="kn">listen</span><span class="w"> </span><span class="mi">443</span><span class="w"> </span><span class="s">ssl</span><span class="w"> </span><span class="s">http2</span><span class="p">;</span><span class="w"></span>
<span class="kn">listen</span><span class="w"> </span><span class="s">[::]:443</span><span class="w"> </span><span class="s">ssl</span><span class="w"> </span><span class="s">http2</span><span class="p">;</span><span class="w"></span>
<span class="kn">server_name</span><span class="w"> </span><span class="s">dashboard.netmaker.example.com</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="kn">location</span><span class="w"> </span><span class="s">/</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="c1"># Proxy!</span>
<span class="w">    </span><span class="kn">include</span><span class="w"> </span><span class="s">conf.d/include/proxy.conf</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="c1">#above file includes:</span>
<span class="w">        </span><span class="c1">#add_header       X-Served-By $host;</span>
<span class="w">        </span><span class="c1">#proxy_set_header Host $host;</span>
<span class="w">        </span><span class="c1">#proxy_set_header X-Forwarded-Scheme $scheme;</span>
<span class="w">        </span><span class="c1">#proxy_set_header X-Forwarded-Proto  $scheme;</span>
<span class="w">        </span><span class="c1">#proxy_set_header X-Forwarded-For    $remote_addr;</span>
<span class="w">        </span><span class="c1">#proxy_set_header X-Real-IP          $remote_addr;</span>
<span class="w">        </span><span class="c1">#proxy_pass       $forward_scheme://$server:$port$request_uri;</span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="c1"># ------------------------------------------------------------</span>
<span class="c1"># api.netmaker.example.com</span>
<span class="c1"># ------------------------------------------------------------</span>
<span class="k">server</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="kn">set</span><span class="w"> </span><span class="nv">$forward_scheme</span><span class="w"> </span><span class="s">http</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="kn">set</span><span class="w"> </span><span class="nv">$server</span><span class="w">         </span><span class="s">&quot;netmaker&quot;</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="kn">set</span><span class="w"> </span><span class="nv">$port</span><span class="w">           </span><span class="mi">8081</span><span class="p">;</span><span class="w"></span>
<span class="kn">listen</span><span class="w"> </span><span class="mi">80</span><span class="p">;</span><span class="w"></span>
<span class="kn">listen</span><span class="w"> </span><span class="s">[::]:80</span><span class="p">;</span><span class="w"></span>
<span class="kn">listen</span><span class="w"> </span><span class="mi">443</span><span class="w"> </span><span class="s">ssl</span><span class="w"> </span><span class="s">http2</span><span class="p">;</span><span class="w"></span>
<span class="kn">listen</span><span class="w"> </span><span class="s">[::]:443</span><span class="w"> </span><span class="s">ssl</span><span class="w"> </span><span class="s">http2</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="kn">server_name</span><span class="w"> </span><span class="s">api.netmaker.example.com</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="kn">location</span><span class="w"> </span><span class="s">/</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="c1"># Proxy!</span>
<span class="w">    </span><span class="kn">include</span><span class="w"> </span><span class="s">conf.d/include/proxy.conf</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="c1">#above file includes:</span>
<span class="w">        </span><span class="c1">#add_header       X-Served-By $host;</span>
<span class="w">        </span><span class="c1">#proxy_set_header Host $host;</span>
<span class="w">        </span><span class="c1">#proxy_set_header X-Forwarded-Scheme $scheme;</span>
<span class="w">        </span><span class="c1">#proxy_set_header X-Forwarded-Proto  $scheme;</span>
<span class="w">        </span><span class="c1">#proxy_set_header X-Forwarded-For    $remote_addr;</span>
<span class="w">        </span><span class="c1">#proxy_set_header X-Real-IP          $remote_addr;</span>
<span class="w">        </span><span class="c1">#proxy_pass       $forward_scheme://$server:$port$request_uri;</span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="c1"># ------------------------------------------------------------</span>
<span class="c1"># grpc.netmaker.example.com</span>
<span class="c1"># ------------------------------------------------------------</span>
<span class="k">server</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="kn">set</span><span class="w"> </span><span class="nv">$forward_scheme</span><span class="w"> </span><span class="s">http</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="kn">set</span><span class="w"> </span><span class="nv">$server</span><span class="w">         </span><span class="s">&quot;netmaker&quot;</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="kn">set</span><span class="w"> </span><span class="nv">$port</span><span class="w">           </span><span class="mi">50051</span><span class="p">;</span><span class="w"></span>
<span class="kn">listen</span><span class="w"> </span><span class="mi">80</span><span class="p">;</span><span class="w"></span>
<span class="kn">listen</span><span class="w"> </span><span class="s">[::]:80</span><span class="p">;</span><span class="w"></span>
<span class="kn">listen</span><span class="w"> </span><span class="mi">443</span><span class="w"> </span><span class="s">ssl</span><span class="w"> </span><span class="s">http2</span><span class="p">;</span><span class="w"></span>
<span class="kn">listen</span><span class="w"> </span><span class="s">[::]:443</span><span class="w"> </span><span class="s">ssl</span><span class="w"> </span><span class="s">http2</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="kn">server_name</span><span class="w"> </span><span class="s">grpc.netmaker.example.com</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="kn">location</span><span class="w"> </span><span class="s">/</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kn">proxy_set_header</span><span class="w"> </span><span class="s">Host</span><span class="w"> </span><span class="nv">$host</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="kn">proxy_set_header</span><span class="w"> </span><span class="s">X-Forwarded-Scheme</span><span class="w"> </span><span class="nv">$scheme</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="kn">proxy_set_header</span><span class="w"> </span><span class="s">X-Forwarded-Proto</span><span class="w">  </span><span class="nv">$scheme</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="kn">proxy_set_header</span><span class="w"> </span><span class="s">X-Forwarded-For</span><span class="w">    </span><span class="nv">$remote_addr</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="kn">proxy_set_header</span><span class="w"> </span><span class="s">X-Real-IP</span><span class="w">          </span><span class="nv">$remote_addr</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="kn">proxy_pass</span><span class="w">       </span><span class="s">http://netmaker:50051</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="kn">grpc_pass</span><span class="w"> </span><span class="n">netmaker</span><span class="p">:</span><span class="mi">50051</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
</section>
<section id="highly-available-installation-kubernetes">
<span id="hainstall"></span><h2>Highly Available Installation (Kubernetes)<a class="headerlink" href="#highly-available-installation-kubernetes" title="Permalink to this headline"></a></h2>
<p>Netmaker comes with a Helm chart to deploy with High Availability on Kubernetes:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">helm</span> <span class="n">repo</span> <span class="n">add</span> <span class="n">netmaker</span> <span class="n">https</span><span class="p">:</span><span class="o">//</span><span class="n">gravitl</span><span class="o">.</span><span class="n">github</span><span class="o">.</span><span class="n">io</span><span class="o">/</span><span class="n">netmaker</span><span class="o">-</span><span class="n">helm</span><span class="o">/</span>
<span class="n">helm</span> <span class="n">repo</span> <span class="n">update</span>
</pre></div>
</div>
<section id="requirements">
<h3>Requirements<a class="headerlink" href="#requirements" title="Permalink to this headline"></a></h3>
<p>To run HA Netmaker on Kubernetes, your cluster must have the following:</p>
<ul>
<li><p>RWO and RWX Storage Classes</p></li>
<li><p>An Ingress Controller and valid TLS certificates</p>
<p>This chart can currently generate ingress for:
- Nginx Ingress + LetsEncrypt/Cert-Manager</p>
<p>To generate automatically, make sure one of the two is configured for your cluster</p>
</li>
<li><p>Ability to set up ingress route for Secure Web Sockets</p>
<p>Nginx Ingress supports Secure Web Sockets (WSS) by default. If you are not using Nginx Ingress, you must route external traffic from broker.domain to the MQTT service, and provide valid TLS certificates.</p>
<p>One option is to set up a Load Balancer which routes broker.domain:443 to the MQTT service on port 8883.</p>
<p>We do not provide guidance beyond this, and recommend using an Ingress Controller that supports websockets.</p>
</li>
</ul>
<p>Furthermore, the chart will by default install and use a postgresql cluster as its datastore:</p>
<table class="docutils align-default">
<colgroup>
<col style="width: 33%" />
<col style="width: 33%" />
<col style="width: 33%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Repository</p></th>
<th class="head"><p>Name</p></th>
<th class="head"><p>Version</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p><a class="reference external" href="https://charts.bitnami.com/bitnami">https://charts.bitnami.com/bitnami</a></p></td>
<td><p>postgresql-ha</p></td>
<td><p>7.11.0</p></td>
</tr>
</tbody>
</table>
</section>
<section id="example-installations">
<h3>Example Installations:<a class="headerlink" href="#example-installations" title="Permalink to this headline"></a></h3>
<p>An annotated install command:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">helm</span> <span class="n">install</span> <span class="n">netmaker</span><span class="o">/</span><span class="n">netmaker</span> <span class="o">--</span><span class="n">generate</span><span class="o">-</span><span class="n">name</span> \ <span class="c1"># generate a random id for the deploy</span>
<span class="o">--</span><span class="nb">set</span> <span class="n">baseDomain</span><span class="o">=</span><span class="n">nm</span><span class="o">.</span><span class="n">example</span><span class="o">.</span><span class="n">com</span> \ <span class="c1"># the base wildcard domain to use for the netmaker api/dashboard/mq ingress</span>
<span class="o">--</span><span class="nb">set</span> <span class="n">server</span><span class="o">.</span><span class="n">replicas</span><span class="o">=</span><span class="mi">3</span> \ <span class="c1"># number of server replicas to deploy (3 by default)</span>
<span class="o">--</span><span class="nb">set</span> <span class="n">ingress</span><span class="o">.</span><span class="n">enabled</span><span class="o">=</span><span class="n">true</span> \ <span class="c1"># deploy ingress automatically (requires nginx and cert-manager + letsencrypt)</span>
<span class="o">--</span><span class="nb">set</span> <span class="n">ingress</span><span class="o">.</span><span class="n">kubernetes</span><span class="o">.</span><span class="n">io</span><span class="o">/</span><span class="n">ingress</span><span class="o">.</span><span class="n">class</span><span class="o">=</span><span class="n">nginx</span> \ <span class="c1"># ingress class to use</span>
<span class="o">--</span><span class="nb">set</span> <span class="n">ingress</span><span class="o">.</span><span class="n">cert</span><span class="o">-</span><span class="n">manager</span><span class="o">.</span><span class="n">io</span><span class="o">/</span><span class="n">cluster</span><span class="o">-</span><span class="n">issuer</span><span class="o">=</span><span class="n">letsencrypt</span><span class="o">-</span><span class="n">prod</span> \ <span class="c1"># LetsEncrypt certificate issuer to use</span>
<span class="o">--</span><span class="nb">set</span> <span class="n">postgresql</span><span class="o">-</span><span class="n">ha</span><span class="o">.</span><span class="n">postgresql</span><span class="o">.</span><span class="n">replicaCount</span><span class="o">=</span><span class="mi">2</span> \ <span class="c1"># number of DB replicas to deploy (default 2)</span>
</pre></div>
</div>
<p>The below command will install netmaker with two server replicas, a coredns server, and ingress with routes of api.nm.example.com, grpc.nm.example.com, and dashboard.nm.example.com. CoreDNS will be reachable at 10.245.75.75, and will use NFS to share a volume with Netmaker (to configure dns entries).</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">helm</span> <span class="n">install</span> <span class="n">netmaker</span><span class="o">/</span><span class="n">netmaker</span> <span class="o">--</span><span class="n">generate</span><span class="o">-</span><span class="n">name</span> <span class="o">--</span><span class="nb">set</span> <span class="n">baseDomain</span><span class="o">=</span><span class="n">nm</span><span class="o">.</span><span class="n">example</span><span class="o">.</span><span class="n">com</span> \
<span class="o">--</span><span class="nb">set</span> <span class="n">replicas</span><span class="o">=</span><span class="mi">2</span> <span class="o">--</span><span class="nb">set</span> <span class="n">ingress</span><span class="o">.</span><span class="n">enabled</span><span class="o">=</span><span class="n">true</span> <span class="o">--</span><span class="nb">set</span> <span class="n">dns</span><span class="o">.</span><span class="n">enabled</span><span class="o">=</span><span class="n">true</span> \
<span class="o">--</span><span class="nb">set</span> <span class="n">dns</span><span class="o">.</span><span class="n">clusterIP</span><span class="o">=</span><span class="mf">10.245.75.75</span> <span class="o">--</span><span class="nb">set</span> <span class="n">dns</span><span class="o">.</span><span class="n">RWX</span><span class="o">.</span><span class="n">storageClassName</span><span class="o">=</span><span class="n">nfs</span> \
<span class="o">--</span><span class="nb">set</span> <span class="n">ingress</span><span class="o">.</span><span class="n">className</span><span class="o">=</span><span class="n">nginx</span>
</pre></div>
</div>
<p>The below command will install netmaker with three server replicas (the default), <strong>no coredns</strong>, and ingress with routes of api.netmaker.example.com, grpc.netmaker.example.com, and dashboard.netmaker.example.com. There will be one UI replica instead of two and one database instance instead of two. Traefik will look for a ClusterIssuer named “le-prod-2” to get valid certificates for the ingress.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">helm3</span> <span class="n">install</span> <span class="n">netmaker</span><span class="o">/</span><span class="n">netmaker</span> <span class="o">--</span><span class="n">generate</span><span class="o">-</span><span class="n">name</span> \
<span class="o">--</span><span class="nb">set</span> <span class="n">baseDomain</span><span class="o">=</span><span class="n">netmaker</span><span class="o">.</span><span class="n">example</span><span class="o">.</span><span class="n">com</span> <span class="o">--</span><span class="nb">set</span> <span class="n">postgresql</span><span class="o">-</span><span class="n">ha</span><span class="o">.</span><span class="n">postgresql</span><span class="o">.</span><span class="n">replicaCount</span><span class="o">=</span><span class="mi">1</span> \
<span class="o">--</span><span class="nb">set</span> <span class="n">ui</span><span class="o">.</span><span class="n">replicas</span><span class="o">=</span><span class="mi">1</span> <span class="o">--</span><span class="nb">set</span> <span class="n">ingress</span><span class="o">.</span><span class="n">enabled</span><span class="o">=</span><span class="n">true</span> \
<span class="o">--</span><span class="nb">set</span> <span class="n">ingress</span><span class="o">.</span><span class="n">tls</span><span class="o">.</span><span class="n">issuerName</span><span class="o">=</span><span class="n">le</span><span class="o">-</span><span class="n">prod</span><span class="o">-</span><span class="mi">2</span> <span class="o">--</span><span class="nb">set</span> <span class="n">ingress</span><span class="o">.</span><span class="n">className</span><span class="o">=</span><span class="n">traefik</span>
</pre></div>
</div>
</section>
<section id="recommended-settings">
<h3>Recommended Settings:<a class="headerlink" href="#recommended-settings" title="Permalink to this headline"></a></h3>
<p>This install has some notable exceptions:
* Ingress <strong>must</strong> be configured on your cluster, with cluster issuer for TLS certs
* DNS will be disabled</p>
<p>Below, we discuss the considerations for Ingress, Kernel WireGuard, and DNS.</p>
</section>
<section id="mq">
<h3>MQ<a class="headerlink" href="#mq" title="Permalink to this headline"></a></h3>
<p>The MQ Broker is deployed either with Ingress (Nginx ) preconfigured, or without. If you are using an ingress controller other than Nginx, Netmaker’s MQTT will not be complete. “broker.domain” must reach the MQTT service at port 8883 over WSS (Secure Web Sockets).</p>
</section>
<section id="ingress">
<h3>Ingress<a class="headerlink" href="#ingress" title="Permalink to this headline"></a></h3>
<p>To run HA Netmaker, you must have ingress installed and enabled on your cluster with valid TLS certificates (not self-signed). If you are running Nginx as your Ingress Controller and LetsEncrypt for TLS certificate management, you can run the helm install with the following settings:</p>
<ul class="simple">
<li><p><cite>–set ingress.enabled=true</cite></p></li>
<li><p><cite>–set ingress.annotations.cert-manager.io/cluster-issuer=&lt;your LE issuer name&gt;</cite></p></li>
</ul>
<p>If you are not using Nginx and LetsEncrypt, we recommend leaving ingress.enabled=false (default), and then manually creating the ingress objects post-install. You will need three ingress objects with TLS:</p>
<ul class="simple">
<li><p><cite>dashboard.&lt;baseDomain&gt;</cite></p></li>
<li><p><cite>api.&lt;baseDomain&gt;</cite></p></li>
<li><p><cite>broker.&lt;baseDomain&gt;</cite></p></li>
</ul>
<p>There are some example ingress objects in the kube/example folder.</p>
</section>
<section id="dns">
<h3>DNS<a class="headerlink" href="#dns" title="Permalink to this headline"></a></h3>
<p>By Default, the helm chart will deploy without DNS enabled. To enable DNS, specify with:</p>
<ul class="simple">
<li><p><cite>–set dns.enabled=true</cite></p></li>
</ul>
<p>This will require specifying a RWX storage class, e.g.:</p>
<ul class="simple">
<li><p><cite>–set dns.RWX.storageClassName=nfs</cite></p></li>
</ul>
<p>This will also require specifying a service address for DNS. Choose a valid ipv4 address from the service IP CIDR for your cluster, e.g.:</p>
<ul class="simple">
<li><p><cite>–set dns.clusterIP=10.245.69.69</cite></p></li>
</ul>
<p><strong>This address will only be reachable from hosts that have access to the cluster service CIDR.</strong> It is only designed for use cases related to k8s. If you want a more general-use Netmaker server on Kubernetes for use cases outside of k8s, you will need to do one of the following:
* bind the CoreDNS service to port 53 on one of your worker nodes and set the COREDNS_ADDRESS equal to the public IP of the worker node.
* Create a private Network with Netmaker and set the COREDNS_ADDRESS equal to the private address of the host running CoreDNS. For this, CoreDNS will need a node selector and will ideally run on the same host as one of the Netmaker server instances.</p>
</section>
<section id="values">
<h3>Values<a class="headerlink" href="#values" title="Permalink to this headline"></a></h3>
<p>To view all options for the chart, please visit the README in the netmaker-helm chart repo <a class="reference external" href="https://github.com/gravitl/netmaker-helm?tab=readme-ov-file#values">here</a> .</p>
</section>
</section>
<section id="security-settings">
<h2>Security Settings<a class="headerlink" href="#security-settings" title="Permalink to this headline"></a></h2>
<p>In some cases, it is useful to secure your web dashboard behind a firewall so it can only be accessed in that location. However, you may not want the API behind that firewall so the other nodes can interact with the network without the heightened security. This can be done in Your Caddyfile if you are using caddy.</p>
<section id="for-caddy">
<h3>For Caddy<a class="headerlink" href="#for-caddy" title="Permalink to this headline"></a></h3>
<p>In your /root/Caddyfile look in the Dashboard section for <code class="docutils literal notranslate"><span class="pre">reverse_proxy</span> <span class="pre">http://netmaker-ui</span></code></p>
<p>Above that line add the following</p>
<div class="highlight-cfg notranslate"><div class="highlight"><pre><span></span><span class="na">@blocked not remote_ip &lt;ip1&gt; &lt;ip2&gt; &lt;ip3&gt;</span><span class="w"></span>
<span class="na">respond @blocked &quot;Nope&quot; 403</span><span class="w"></span>
</pre></div>
</div>
<p>Replace the &lt;ip&gt; placeholders with your whitelist IP ranges.</p>
</section>
<section id="for-traefik">
<h3>For Traefik<a class="headerlink" href="#for-traefik" title="Permalink to this headline"></a></h3>
<ol class="arabic simple">
<li><p>In the labels section, add the following line:</p></li>
</ol>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="l l-Scalar l-Scalar-Plain">traefik.http.middlewares.nmui-security-1.ipwhitelist.sourcerange=YOUR_IP_CIDR</span><span class="w"></span>
</pre></div>
</div>
<ol class="arabic simple" start="2">
<li><p>Then look for this line:</p></li>
</ol>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="l l-Scalar l-Scalar-Plain">traefik.http.routers.netmaker-ui.middlewares=nmui-security@docker</span><span class="w"></span>
</pre></div>
</div>
<p>and change it to this:</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="l l-Scalar l-Scalar-Plain">traefik.http.routers.netmaker-ui.middlewares=nmui-security-1@docker,nmui-security@docker</span><span class="w"></span>
</pre></div>
</div>
<p>Replace YOUR_IP_CIDR with the whitelist IP range (can be multiple ranges).</p>
<p>After changes are made for your reverse proxy, <code class="docutils literal notranslate"><span class="pre">docker-compose</span> <span class="pre">down</span> <span class="pre">&amp;&amp;</span> <span class="pre">docker-compose</span> <span class="pre">up</span> <span class="pre">-d</span></code> and you should be all set. You can now keep your dashboard secure and your API more available without having to change netmaker-ui ports.</p>
</section>
</section>
<section id="setup-netmaker-on-ipv6-only-machine">
<h2>Setup Netmaker on IPv6 only machine<a class="headerlink" href="#setup-netmaker-on-ipv6-only-machine" title="Permalink to this headline"></a></h2>
<p>This is not a guide how to add an overlay network(with IPv6) in Netmaker, it can be found in <a class="reference external" href="https://docs.netmaker.io/getting-started.html#setup">Setup</a> page.
This is to setup Netmaker working on an IPv6 only machine.</p>
<section id="about-the-install-script-nm-quick-sh">
<h3>About the install script nm-quick.sh<a class="headerlink" href="#about-the-install-script-nm-quick-sh" title="Permalink to this headline"></a></h3>
<p>At the moment which the document is written, the install script <cite>nm-quick.sh</cite> only supports IPv4. For the installation, the IPv4 needs to be enabled temporary anyway.</p>
</section>
<section id="add-aaaa-record-for-domain-name-resolution">
<h3>Add AAAA record for domain name resolution<a class="headerlink" href="#add-aaaa-record-for-domain-name-resolution" title="Permalink to this headline"></a></h3>
<p>The Netmaker client communicates with Netmaker server by domain name.   AAAA record here is to resolve the domain name to IPv6 address.</p>
<p>By default, Netmaker works on IPv4. Because Docker works on IPv4 by default.  After the installation, there are several steps to enable IPv6 for Docker and Netmaker.</p>
</section>
<section id="enable-ipv6-support-for-docker">
<h3>Enable IPv6 support for Docker<a class="headerlink" href="#enable-ipv6-support-for-docker" title="Permalink to this headline"></a></h3>
<ol class="arabic simple">
<li><p>Add/Edit the configuration file <cite>/etc/docker/daemon.json</cite>:</p></li>
</ol>
<div class="highlight-json notranslate"><div class="highlight"><pre><span></span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="nt">&quot;experimental&quot;</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span><span class="w"></span>
<span class="w">  </span><span class="nt">&quot;ip6tables&quot;</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<ol class="arabic simple" start="2">
<li><p>Restart the Docker daemon for your changes to take effect.</p></li>
</ol>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">systemctl</span> <span class="n">restart</span> <span class="n">docker</span>
</pre></div>
</div>
<ol class="arabic simple" start="3">
<li><p>Create a new IPv6 network, for example,</p></li>
</ol>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">docker</span> <span class="n">network</span> <span class="n">create</span> <span class="o">--</span><span class="n">ipv6</span> <span class="o">--</span><span class="n">subnet</span> <span class="mi">2001</span><span class="p">:</span><span class="mi">0</span><span class="n">DB8</span><span class="p">::</span><span class="o">/</span><span class="mi">112</span> <span class="n">ip6net</span>
</pre></div>
</div>
<p>where “ip6net” is the network name, “2001:0DB8::/112” is the network range.</p>
</section>
<section id="enable-ipv6-support-for-netmaker">
<h3>Enable IPv6 support for Netmaker<a class="headerlink" href="#enable-ipv6-support-for-netmaker" title="Permalink to this headline"></a></h3>
<ol class="arabic simple">
<li><p>Edit <cite>docker-compose.yml</cite> file and add the following lines at the bottom.</p></li>
</ol>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">networks</span><span class="p">:</span><span class="w"></span>
<span class="w">  </span><span class="nt">ip6net</span><span class="p">:</span><span class="w"></span>
<span class="w">    </span><span class="nt">external</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span><span class="w"></span>
</pre></div>
</div>
<ol class="arabic simple" start="2">
<li><p>The same in <cite>docker-compose.yml</cite> file, add <cite>networks</cite> field for every service.</p></li>
</ol>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">networks</span><span class="p">:</span><span class="w"></span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ip6net</span><span class="w"></span>
</pre></div>
</div>
<ol class="arabic simple" start="3">
<li><p>Run commands <cite>“docker-compose down”</cite> and <cite>“docker-compose up -d”</cite> to restart Netmaker server</p></li>
</ol>
</section>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="advanced-client-install.html" class="btn btn-neutral float-left" title="Advanced Client Installation" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="features.html" class="btn btn-neutral float-right" title="Features" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2024, Netmaker Inc..</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>